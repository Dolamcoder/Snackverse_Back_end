<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Chọn địa chỉ trên bản đồ</title>
  <style>
    #map { height: 480px; width: 100%; border: 1px solid #ccc; }
    .controls { margin: 8px 0; }
  </style>
</head>
<body>
  <h3>Chọn địa chỉ</h3>

  <div class="controls">
    <button id="btnCurrent">Dùng vị trí hiện tại</button>
    <button id="btnSave">Lưu địa chỉ (gửi về backend)</button>
  </div>

  <div id="map"></div>

  <p><strong>Địa chỉ:</strong> <span id="address">Chưa chọn</span></p>
  <p><strong>Tọa độ:</strong> <span id="coords">-</span></p>

  <!-- Google Maps JS (Maps JavaScript API). Thay YOUR_API_KEY -->
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places&callback=initMap" async defer></script>

  <script>
    let map, marker, geocoder;
    // Mặc định (ví dụ: trung tâm Đà Nẵng)
    const defaultLatLng = { lat: 16.047079, lng: 108.206230 };

    function initMap() {
      geocoder = new google.maps.Geocoder();

      map = new google.maps.Map(document.getElementById("map"), {
        center: defaultLatLng,
        zoom: 13,
      });

      marker = new google.maps.Marker({
        position: defaultLatLng,
        map,
        draggable: true,
      });

      // Lấy địa chỉ ban đầu
      reverseGeocode(defaultLatLng);

      // Click trên bản đồ -> đặt marker + reverse geocode
      map.addListener("click", (e) => {
        const latlng = { lat: e.latLng.lat(), lng: e.latLng.lng() };
        marker.setPosition(e.latLng);
        reverseGeocode(latlng);
      });

      // Kéo marker xong -> lấy lại vị trí
      marker.addListener("dragend", () => {
        const pos = marker.getPosition();
        const latlng = { lat: pos.lat(), lng: pos.lng() };
        reverseGeocode(latlng);
      });

      document.getElementById("btnCurrent").addEventListener("click", useCurrentLocation);
      document.getElementById("btnSave").addEventListener("click", sendToBackend);
    }

    // Reverse geocode (lat,lng -> formatted_address)
    function reverseGeocode(latlng) {
      geocoder.geocode({ location: latlng }, (results, status) => {
        if (status === "OK" && results && results[0]) {
          const addr = results[0].formatted_address;
          document.getElementById("address").innerText = addr;
          document.getElementById("coords").innerText = latlng.lat + ", " + latlng.lng;
          // Lưu current vào window để gửi sau
          window._selectedAddress = { lat: latlng.lat, lng: latlng.lng, address: addr };
          console.log("Reverse geocode:", window._selectedAddress);
        } else {
          document.getElementById("address").innerText = "Không tìm thấy địa chỉ";
          window._selectedAddress = { lat: latlng.lat, lng: latlng.lng, address: null };
          console.error("Geocoder failed:", status);
        }
      });
    }

    // Dùng vị trí hiện tại của thiết bị
    function useCurrentLocation() {
      if (!navigator.geolocation) {
        alert("Trình duyệt không hỗ trợ Geolocation.");
        return;
      }
      navigator.geolocation.getCurrentPosition((pos) => {
        const latlng = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        map.panTo(latlng);
        map.setZoom(16);
        marker.setPosition(latlng);
        reverseGeocode(latlng);
      }, (err) => {
        alert("Không thể lấy vị trí hiện tại: " + err.message);
      }, { enableHighAccuracy: true, timeout: 10000 });
    }

    // Gửi dữ liệu đã chọn về backend (POST JSON)
    async function sendToBackend() {
      const payload = window._selectedAddress;
      if (!payload || !payload.address) {
        if (!payload) return alert("Chưa chọn điểm để lưu.");
        // vẫn cho phép lưu lat/lng nếu address null
      }
      try {
        const res = await fetch('/api/addresses', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            // nếu dùng Laravel với CSRF, bạn có thể cần thêm X-CSRF-TOKEN header
          },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(res.status + ' ' + text);
        }
        const data = await res.json();
        alert('Lưu thành công!');
        console.log('Server response:', data);
      } catch (err) {
        console.error(err);
        alert('Lỗi khi gửi về server: ' + err.message);
      }
    }
  </script>
</body>
</html>
